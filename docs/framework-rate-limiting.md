---
title: Apache Mesos - Framework Rate Limiting
layout: documentation
---

# フレームワーク速度制限
フレームワークレートの制限は、Mesos 0.20.0で導入された機能です。

## フレームワーク速度制限とは
この機能は、マルチフレームワーク環境において、マスターが他のフレームワーク（例：開発、バッチ）からのメッセージをスロットルすることで、HLAの高いフレームワーク（例：プロダクション、サービス）のスループットを保護することを目的としています。

フレームワークからのメッセージをスロットルするには、Mesosクラスタのオペレータが、プリンシパルによって特定される各フレームワークに`qps`（queries per seconds）値を設定します（フレームワークのグループをまとめてスロットルすることもできますが、このドキュメントでは特に断りがない限り個々のフレームワークを想定しています：以下の`RateLimits` [Protobufの定義](https://github.com/apache/mesos/blob/master/include/mesos/mesos.proto)と設定上の注意を参照してください）。マスターは、そのフレームワークからのメッセージを`qps`以上のレートで処理しないことを約束します。未処理のメッセージはマスターのメモリに保存されます。

## 速度制限の設定
以下は、`--rate_limits` masterフラグで指定可能な設定ファイルのサンプル（JSON形式）です。

    {
      "limits": [
        {
          "principal": "foo",
          "qps": 55.5
          "capacity": 100000
        },
        {
          "principal": "bar",
          "qps": 300
        },
        {
          "principal": "baz",
        }
      ],
      "aggregate_default_qps": 333,
      "aggregate_default_capacity": 1000000
    }

この例では、フレームワーク `foo` は設定された `qps` と容量でスロットルされ、フレームワーク `bar` は無制限の`capacity`が与えられ、フレームワーク `baz` はまったくスロットルされません。もし、マスターに4番目のフレームワーク `qux` やプリンシパルのいないフレームワークが接続されている場合は、 `aggregate_default_qps` と `aggregate_default_capacity` というルールでスロットルがかけられます。

### 設定上の注意
以下は、JSON構成のフィールドです。

- **principal**: (必須) 絞り込みまたは無制限レートを明示的に与えられているエンティティを一意に識別します。
    - フレームワークの`FrameworkInfo.principal`（[定義](https://github.com/apache/mesos/blob/master/include/mesos/mesos.proto)参照）と一致する必要があります。
    - 複数のフレームワークが同じプリンシパルを使用することができますが（例えば、Mesosフレームワークの中には、ジョブごとに新しいフレームワークインスタンスを起動するものがあります）、その場合、同じプリンシパルを使用するすべてのフレームワークからのトラフィックを合計すると、指定されたQPSでスロットルされます。
- **qps**: (オプション) 1秒あたりのクエリ数、つまりレートです。
    - 一度設定されると、マスターは、このプリンシパルからのメッセージをこのレートよりも高く処理しないことを保証します。しかし、特に指定されたレートが高すぎる場合には、マスターはこのレートよりも遅くなる可能性があります。
    - フレームワークに無制限のレートを明示的に与える（つまり、スロットルをかけない）には、qpsを除いた`limits`にエントリを追加します。
- **capacity**: (オプション) このプリンシパルのフレームワークがマスターにかけることができる未処理メッセージの数です。指定されていない場合、このプリンシパルには無制限の容量が与えられます。容量の設定が高すぎたり、設定されていない場合、キューに入れられたメッセージがメモリを使いすぎて、マスターがOOMになる可能性があることに注意してください。
    - 注: `qps`が指定されていない場合、`capacity`は無視されます。
- **aggregate_default_qps** および **aggregate_default_capacity** を使用して、指定されていないフレームワークからマスターを保護します。`limits`で指定されていないフレームワークはすべて、このデフォルトレートとキャパシティを取得します。
    - レートとキャパシティは、すべての人のための集約された値であり、つまり、それらを合わせたトラフィックが一緒にスロットルされます。
    - 上記と同様に、`aggregate_default_qps`が指定されていない場合、`aggregate_default_capacity`は無視されます。
    - これらのフィールドが存在しない場合、指定されていないフレームワークはスロットルされません。これは、上記の明示的な方法 (プリンシパルのみの`limits`のエントリを使用する) と比較して、フレームワークに無制限のレートを与える暗黙の方法です。特にマスターが認証を必要としない場合は、想定外のフレームワークがマスターを圧迫するのを防ぐため、明示的なオプションの使用をお勧めします。

## フレームワーク速度制限の使用

### フレームワーク トラフィックの監視
フレームワークがマスターに登録されている間、マスターはそのフレームワークから受信したすべてのメッセージと処理されたメッセージのカウンターをメトリクス・エンドポイント`http://<master>/metrics/snapshot`で公開します。例えば、フレームワーク`foo`は2つのメッセージカウンタ`frameworks/foo/messages_received`と`frameworks/foo/messages_processed`を持っています。フレームワークのレート制限がない場合、この2つの数値の差はほとんどないはずですが（メッセージはすぐに処理されるため）、フレームワークがスロットルされている場合、その差はスロットルの結果としての未処理メッセージを示しています。

カウンタを継続的に監視することで、メッセージが到着する割合や、フレームワークのメッセージキューの長さがどれくらい速くなっているかを導き出すことができます（スロットルがかかっている場合）。これは、ネットワーク・トラフィックの観点から見たフレームワークの特性を示すものです。

## 速度制限の設定をする
フレームワークのレート制限の目的は、低SLAフレームワークがリソースを使いすぎないようにすることであり、フレームワークのトラフィックや動作を可能な限り正確にモデル化することではないため、大きな`qps`値を使ってスロットルすることから始めることができます。設定された`qps`に関わらず）スロットルされているという事実は、高SLAフレームワークからのメッセージが早急に処理されるため、より高い優先度を与えるという点ですでに効果的です。

マスターが処理できる`capacity`を計算するには、マスタープロセスのメモリ制限、レート制限をかけずに同様のワークロードを処理する際に通常使用するメモリ量（`ps -o rss $MASTER_PID`などを使用）、フレームワークのメッセージの平均サイズ（キューイングされたメッセージは、[いくつかのフィールドを追加したシリアル化されたProtocol Buffer](https://github.com/apache/mesos/blob/master/3rdparty/libprocess/include/process/message.hpp)として保存されます）を知り、設定ですべての容量値を合計する必要があります。しかし、この種の計算は不正確なので、一時的なフレームワークのバーストを許容する小さな値から始めるべきですが、マスターと容量が制限されていないフレームワークのために十分な余裕を残しておくために、メモリ制限からは離れています。

## 容量超過エラーの処理
フレームワークが**容量を超えると**、FrameworkErrorMessageがフレームワークに送り返され、[スケジューラドライバを中止し、error()コールバック](https://github.com/apache/mesos/blob/master/src/sched/sched.cpp)を呼び出します。これは、タスクやスケジューラ自体を殺すものではありません。フレームワークの開発者は、ドロップされたメッセージの結果を改善するために、スケジューラのインスタンスを再起動またはフェイルオーバーすることを選択できます（フレームワークがマスターに送信されたすべてのメッセージが処理されることを想定していない場合）。

バージョン0.20.0以降では、このフレームワークのメッセージキューが**構築され始めたとき**（[MESOS-1664](https://issues.apache.org/jira/browse/MESOS-1664)、"ソフトリミット "と考えてください）、マスターが早期にアラートを送信することで、この機能を繰り返し使用する予定です。スケジューラは、（エラーメッセージを回避するために）自分自身をスロットルするか、設計上の一時的なバーストであれば、このアラートを無視することで対応できます。

早期警告が実装される前に、エラーメッセージの結果について確信が持てない限り、**今のところレート制限機能を使って本番フレームワークをスロットルすることはお勧めしません。** もちろん、他のフレームワークをスロットルして本番フレームワークを保護するために使用することは問題ありませんし、明示的に有効になっていない場合はマスターに何の影響も与えません。
