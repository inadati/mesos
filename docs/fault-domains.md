---
title: Apache Mesos - Domains and Regions
layout: documentation
---

# リージョンとフォールトドメイン
Mesos 1.5では、Mesosマスターとエージェントをドメインに配置することができます。ドメインとは、いくつかの特徴を共有するマシンの論理的なグループです。

現在、サポートされているのは障害ドメインのみで、これは同様の障害特性を持つマシンのグループを指します。

フォールト・ドメインは、リージョンとゾーンの2レベルの階層で構成されています。フォールトドメインから物理インフラへのマッピングは、オペレータの設定次第ですが、同じゾーンにあるマシンは互いに低レイテンシーであることが推奨されます。

クラウド環境では、リージョンとゾーンは、ほとんどのクラウドプロバイダーが提供する「リージョン」と「アベイラビリティー・ゾーン」という概念にそれぞれマッピングすることができます。また、オンプレミス環境では、リージョンとゾーンはそれぞれデータセンターとラックに対応します。

スケジューラーは、ネットワークを多用するワークロードを同じドメイン内に配置することで、パフォーマンスを向上させることができます。逆に、あるドメインのホストに発生した単一の障害は、同じドメインの他のホストにも影響を与える可能性が高いため、スケジューラーは高可用性を必要とするワークロードを複数のドメインに配置することを好む場合があります。例えば、1つのラック内のすべてのホストが同時に電源やネットワーク接続を失う可能性があります。

マスターノードまたはエージェントノードのフォールトドメインを指定するには、`--domain` フラグを使用します。このフラグの値は、ファイルパスまたは、キー `fault_domain` とサブキー `region` および `zone` が任意の文字列にマッピングされた JSON 辞書でなければなりません。:

    mesos-master --domain='{"fault_domain": {"region": {"name":"eu"}, "zone": { "name":"rack1"}}}'

    mesos-agent  --domain='{"fault_domain": {"region": {"name":"eu"}, "zone": {"name":"rack2"}}}'

フレームワークは、受信したオファーの domain フィールドを調べることで、エージェントのドメインを知ることができます。この `domain` フィールドには、上記の JSON 辞書と同じ構造を持つ `DomainInfo` が含まれています。

# 制約事項

マスターとエージェントにフォールトドメインを設定する際には、以下の制約に従わなければなりません。:
* mesos masterにドメインが設定されていない場合、ドメインを持つエージェントからの接続試行を拒否します。これは、マスターが、この場合にエージェントがリモートになるかどうかを判断できないために行われます。

* ドメインが設定されていないエージェントは、マスターと同じドメインにいるものとみなされます。この動作を望まない場合は、マスターの `--require_agent_domain` フラグを使用して、ドメインが設定されていないエージェントによるすべての登録の試みをマスターが拒否することにより、すべてのエージェントにドメインが設定されていることを強制することができる。

* 1つのマスターにドメインが設定されている場合、他のすべてのマスターは、 リージョン間のクォーラム書き込みを避けるために、同じ「リージョン」にいなければなりません。高可用性のためには、その地域内の異なるゾーンに配置することが推奨される。

* デフォルトのDRFリソースアロケータは、マスターと同じリージョンのエージェントからしかリソースをオファーしません。すべてのリージョンからオファーを受け取るには、フレームワークはそのFrameworkInfoに`REGION_AWARE`ケイパビリティビットを設定する必要があります。

# 例
これらの概念を説明するために、短い例を挙げます。WayForward Technologiesは、ユーザーが欲しいものを購入できるウェブサイトを運営しています。

そのために、サンフランシスコにデータセンターを所有し、その中でいくつかのカスタムMesosフレームワークを稼働させています。データセンター内のすべてのエージェントは、同じリージョン`sf`で設定されており、データセンター内の個々のラックはゾーンとして使用されています。

3台のメソスマスターは、データセンター内の異なるサーバーラックに設置されており、ラック全体の電源やネットワーク接続が失われた場合でも、十分な分離性を確保しつつ、クォーラム書き込みに必要な低遅延を実現しています。

提供されるサービスの1つに、会社のインベントリのリアルタイム表示があります。このサービスを提供するフレームワークは、すべてのタスクをデータベースサーバと同じゾーンに配置し、高速かつ低レイテンシーのリンクを利用して、常に最新の結果を表示できるようにしています。

ピーク時には、Webサイトの運用に必要なコンピューティングパワーがデータセンターのキャパシティを超えてしまうこともあります。不必要なハードウェアの購入を避けるため、WayForward TechnologiesはサードパーティのクラウドプロバイダーであるTPCと契約した。このプロバイダーのマシンは、異なるリージョンの`tpc`に配置され、ゾーンはTPCが提供するアベイラビリティー・ゾーンに対応するように構成されています。すべての関連するフレームワークは、`FrameworkInfo`の`REGION_AWARE`ビットが更新され、スケジューリング・ロジックが更新されて、必要に応じてクラウドでタスクをスケジューリングできるようになりました。

リージョンを意識しないフレームワークは、マスターノードが存在するデータセンター内のエージェントからのみオファーを受け取ります。リージョンアウェアのフレームワークは、いつ、どのタイミングでタスクをデータセンターに置くべきか、あるいはクラウド・プロバイダーに置くべきかを知ることができます。
