---
title: Apache Mesos - Memory Profiling
layout: documentation
---

# MesosとJemallocによるメモリ・プロファイリング
Linuxシステムでは、Mesosは汎用アロケータ[jemalloc](http://jemalloc.net)のメモリ・プロファイリング機能を活用して、メモリ関連の問題を調査するための強力なデバッグ・ツールを提供しています。

これには、現在のメモリ使用量の詳細なリアルタイム統計や、個々の割り当ての場所と頻度に関する情報が含まれます。

これは一般的に、現在のプロセスがメモリアロケータとして jemalloc を使用しているかどうかを libprocess が実行時に検出し、使用している場合は、オペレータが実行時に必要なデータを生成できるように、以下に説明するいくつかの HTTP エンドポイントを有効にすることで動作します。

<a name="requirements"></a>
## Requirements

メモリプロファイリングの前提条件として、適切なアロケータが必要です。現在はjemallocのみがサポートされており、以下のいずれかの方法で接続することができます。

推奨される方法は、`--enable-jemalloc-allocator`コンパイル時フラグを指定することです。これにより、`mesos-master`および`mesos-agent`バイナリは、正しいコンパイル時フラグでコンパイルされたjemallocのバンドルバージョンと静的にリンクされます。

また、Mesosの他のバンドルされた依存関係と同様に、`--with-jemalloc=</path-to-jemalloc>`フラグを使用して、適切なカスタムバージョンのjemallocを使用することももちろん可能です。

注：ここでの適切とは、jemallocが`--enable-stats`および`--enable-prof`フラグを付けてビルドされていること、および文字列`prof:true;prof_active:false`がmallocの設定の一部であることを意味します。後者の条件は、設定時または実行時に満たすことができます。後述の`MALLOC_CONF`のセクションを参照してください。

3 つ目の方法は、`LD_PRELOAD` メカニズムを使用して、実行時にシステムに存在する `libjemalloc.so` 共有ライブラリをプリロードすることです。libprocessの`MemoryProfiler`クラスは自動的にこれを検出して、メモリプロファイリングサポートを有効にします。

生成されたプロファイルダンプは、設定されていれば `TMPDIR` の下のランダムなディレクトリに書き込まれ、そうでなければ `/tmp` のサブディレクトリに書き込まれます。

最後に、jemallocは高度に同時進行する割り当てシナリオで使用するように設計されているため、デフォルトのシステムアロケータよりもパフォーマンスが向上することがあることに注意してください。この場合、メモリプロファイリング機能を使用する意図がなくても、jemallocを使用してMesosを構築することは有益です。

## 使用方法
jemallocから収集できるデータには、メモリ統計とヒーププロファイリング情報の2つの独立したセットがあります。

以下に説明するエンドポイントを使用するには、[jemallocアロケータ要件](#requirements)と、オプション`--memory_profiling=true`で`mesos-agent`または`mesos-master`バイナリを起動する必要があります（または、libprocessを使用する他のバイナリでは、環境変数`LIBPROCESS_MEMORY_PROFILING=true`を設定する必要があります）。

### メモリの統計情報

`/statistics`エンドポイントは、現在割り当てられているバイト数や、これらの割り当てのサイズ分布など、メモリ使用量に関する正確な統計情報をJSON形式で返します。

パラメータはなく、JSON形式で結果が返されます。:

    http://example.org:5050/memory-profiler/statistics

返されるJSONはかなり大きいので、ターミナルからこのエンドポイントにアクセスする場合は、結果をファイルにリダイレクトすることをお勧めします。


### ヒープのプロファイリング
jemallocによるプロファイリングは、設定された確率分布に従って`malloc()`の呼び出しからサンプリングを行い、サンプリングされた呼び出しのスタックトレースを別のメモリ領域に保存します。これらは、ファイルシステム上のファイル、いわゆるヒーププロファイルにダンプすることができます。

プロファイリングの実行を開始するには、`/start` エンドポイントにアクセスします。:

    http://example.org:5050/memory-profiler/start?duration=5mins

続いて、時間が経過した後、以下に説明する生成ファイルの1つをダウンロードします。現在のプロファイリング実行の残り時間は、`/state`エンドポイントで確認できます。:

    http://example.org:5050/memory-profiler/state

プロファイリング情報はjemallocによってプロセス・グローバルに保存されるため、1回のプロファイリングの同時実行しかできません。さらに、直近に終了した実行の結果のみがディスクに保存されます。

プロファイル・コレクションは、`/stop`エンドポイントで早期に停止することもできます。:

    http://example.org:5050/memory-profiler/stop

To analyze the generated profiling data, the results are offered in three
different formats.

#### 生のプロファイル

    http://example.org:5050/memory-profiler/download/raw

これは、収集された生のバックトレース、すなわち、メモリアドレスのリストを含むプレーンテキスト形式のファイルを返します。このファイルは、jemallocプロジェクトで提供されている`jeprof`ツールを使って、インタラクティブに分析したり、レンダリングしたりすることができます。このファイルフォーマットの詳細については、[jemallocの公式ドキュメント](http://jemalloc.net/jemalloc.3.html#heap_profile_format)をご覧ください。

#### 象徴的なプロファイル

    http://example.org:5050/memory-profiler/download/text

これは、上記の raw フォーマットと似ていますが、ホスト・マシン上で `jeprof` が呼び出され、現在のバイナリからシンボル情報を読み取って、プロファイル内の生のメモリ・アドレスを人間が読めるシンボル名に置き換えることを試みます。

このエンドポイントを使用するには、`jeprof`がホスト・マシン上および`PATH`上に存在する必要があり、バイナリにシンボル情報が含まれていない限り、有用な情報は生成されません。

#### Call graph

    http://example.org:5050/memory-profiler/download/graph

このエンドポイントは、サンプルのバックトレースをグラフィカルに表現したSVG形式の画像を返します。

このエンドポイントを使用するには、ホストマシンとmesosの`PATH`に`jeprof`と`dot`が存在する必要があり、バイナリにシンボル情報が含まれていないと有用な情報は生成されません。

#### 概要
これらのうちどれが必要かは、アプリケーションの展開状況や調査対象となるバグの状況によって異なります。

例えば、コールグラフは情報を視覚的にすぐに役立つ形で表示しますが、デフォルト以外の出力オプションが必要な場合、フィルタリングや後処理が困難です。

一方、多くのdebian-like環境では、スペースを節約するためにシンボル情報はデフォルトでバイナリから取り除かれ、別のパッケージで出荷されます。このような環境では、Mesosを実行しているホストに追加パッケージをインストールすることが許可されていない場合、生のプロファイルを保存し、ローカルでシンボル情報でリッチ化することになります。

## Jeprof のインストール
上述のとおり、`/download/text`および`/download/graph`エンドポイントでは、ホストシステムに`jeprof`プログラムがインストールされている必要があります。可能であれば、システム・パッケージ・マネージャを介して`jeprof`をインストールすることをお勧めし、通常はjemalloc自体と一緒にパッケージされています。

また、スクリプトのコピーは、ビルドディレクトリーの`3rdparty/jemalloc-5.0.1/bin/jeprof`の下にあり、次のようなコマンドでインターネットから直接ダウンロードすることもできます。:

    $ curl https://raw.githubusercontent.com/jemalloc/jemalloc/dev/bin/jeprof.in | sed s/@jemalloc_version@/5.0.1/ >jeprof

`jeprof`は、生のプロファイルを後処理する単なるPerlスクリプトであることに注意してください。`jeprof`は、同じパッケージで配布されていること以外に、jemallocライブラリとは何の関係もありません。特に、jemallocと`jeprof`のバージョンが一致している必要は、一般的にはありません。

`jeprof`を手動でインストールする場合は、必要な依存関係をインストールすることにも注意する必要があります。具体的には、スクリプトを実行するための`Perl`インタープリタや、グラフファイルを生成するための`dot`バイナリなどがあります。

## コマンドラインでの使い方

状況によっては、簡単なスクリプトを書いて、ヒーププロファイルのダウンロードを自動化したい場合があります。簡単な例を挙げると、次のようになります。:

    #!/bin/bash

    SECONDS=600
    HOST=example.org:5050

    curl ${HOST}/memory-profiler/start?duration=${SECONDS}
    sleep $((${SECONDS} + 1))
    wget ${HOST}/memory-profiler/download/raw

より洗練されたスクリプトでは、`/start`の呼び出しによって返された`id`値をさらに保存し、それを`/download`のパレンマとして渡すことで、その間に新しいランが開始されないようにします。

## `MALLOC_CONF`インターフェースの使用
jemallocアロケータは、メモリプロファイリングの動作を制御するためのネイティブインターフェースを提供します。このインターフェイスを通して設定を提供する通常の方法は、環境変数 `MALLOC_CONF` を設定することです。

**注意:** メモリプロファイリングが `MALLOC_CONF` を通して開始されたことを libprocess が検出した場合、干渉を避けるためにそれ自身のプロファイリング実行の開始を拒否します。

`MALLOC_CONF` インターフェースは、一定量のメモリが割り当てられた後、またはメモリ使用量が新たな高水位に達した時に自動的にヒーププロファイルを生成するような、libprocess が公開していない多くのオプションを提供します。設定の全リストは [jemalloc man page](http://jemalloc.net/jemalloc.3.html)に記載されています。

一方で、実行時にプロファイリングを開始/停止したり、`/statistics`エンドポイントで提供される情報を取得したりする機能は、`MALLOC_CONF`インターフェースでは実現できません。

例えば、記録された1GiB分の割り当てごとに自動的にダンプを作成するには、次のような設定を使用します。:

    MALLOC_CONF="prof:true,prof_prefix:/path/to/folder,lg_prof_interval=20"

初期起動時のメモリ割り当てをデバッグするために、`/start`エンドポイントにアクセスする前にプロファイリングを有効にすることができます。:

    MALLOC_CONF="prof:true,prof_active:true"
