---
title: Apache Mesos - Agent Recovery
layout: documentation
---

# エージェントのリカバリー

ホスト上の`mesos-agent`プロセスが終了した場合(Mesosのバグ、またはオペレータが[Mesosのアップグレード](upgrades.md)中にプロセスを強制終了した場合)、`mesos-agent`プロセスが管理していたすべてのエクゼキュータ/タスクは引き続き実行されます。

デフォルトでは、古い`mesos-agent`プロセスによって管理されていたすべてのエクゼキュータ/タスクは、自分自身で終了することが期待され、終了しなかった場合はエージェントの再起動後にシャットダウンされます。

しかし、フレームワークがマスターへの登録時にチェックポイントを有効にしていれば、そのフレームワークに属するエクゼキュータは、新しい`mesos-agent`プロセスに再接続し、中断することなく実行を続けることができます。したがって、フレームワークのチェックポインティングを有効にすると、タスクは`mesos-agent`のアップグレードや予期せぬクラッシュにもダウンタイムを発生させることなく耐えることができます。

エージェントのリカバリは、エージェントが自身の状態や管理しているタスクやエクゼキュータに関する情報をローカルディスクにチェックポイントさせることで機能します。例えば、`SlaveInfo`、`FrameworkInfo`、`ExecutorInfo`メッセージや、実行中のタスクの確認されていないステータスアップデートなどです。

エージェントの再起動時には、環境変数やコマンドライン・フラグから設定された現在の設定が、チェックポイントされた情報と互換性があるかどうかを確認し、互換性がない場合は再起動を拒否します。

特殊なケースとして、エージェントの最後の実行後にホストシステムが再起動されたことをエージェントが検出した場合があります。エージェントは通常通り前回のIDを回復しようとしますが、失敗した場合は実際に前回の実行の情報を消去し、新しいエージェントとしてマスターに登録します。

エージェントのシャットダウンから再起動までの間に終了したエクゼキュータやタスクは、エージェントの復旧時には自動的に再起動されないことに注意してください。

## フレームワークの構成
フレームワークは、マスターへの登録時に`FrameworkInfo`に`チェックポイントフラグ`を設定することで、そのエクゼキュータがリカバリされるかどうかを制御できます。この機能を有効にすると、フレームワークが起動したタスクを実行する各エージェントのI/Oオーバーヘッドが増加します。デフォルトでは、フレームワークはその状態をチェックポイントしません。
## エージェントの構成

4つの[設定フラグ](configuration/agent.md)は、Mesosエージェントの回復動作を制御します。

* `strict`:エージェントのリカバリーをストリクトモードで行うかどうか [Default: true]
  - strict=trueの場合、すべてのリカバリーエラーは致命的なものとみなされます。
  - strict=falseの場合、リカバリー中のエラー（チェックポイントされたデータの破損など）は無視され、可能な限り多くの状態がリカバリーされます。

* `reconfiguration_policy`:復旧の際にどのような設定変更を受け入れるか [Default: equal]
  - reconfiguration_policy=equalの場合は、設定変更を受け付けません。
  - reconfiguration_policy=additiveの場合、エージェントは、新しい構成に追加の属性、リソースの増加、または追加のフォールトドメインを含めることを許可します。より詳細な説明については、[こちら](https://gitbox.apache.org/repos/asf?p=mesos.git;a=blob;f=src/slave/compatibility.hpp;h=78b421a01abe5d2178c93832577577a7ba282b38;hb=HEAD#l37)を参照してください。

* `recover`: ステータスの更新を回復し、古いエグゼキューターと再接続するかどうか [Default: reconnect]
    - recover=reconnectの場合、エグゼキューターのフレームワークがチェックポインティングを有効にしていれば、古い稼働中のエグゼキューターと再接続します。
    - recover=cleanupの場合は、古い稼働中のエグゼキューターをすべてシャットダウンします。このオプションは、互換性のないエージェントやエクゼキュータのアップグレードを行う場合に使用してください。**注:**チェックポイント情報が存在しない場合、リカバリーは行われず、エージェントは新しいエージェントとしてマスターに登録されます。

* `recovery_timeout`: エージェントが回復するために割り当てられる時間 [Default: 15 mins].
    - エージェントの復旧に `recovery_timeout` 以上の時間がかかった場合、エージェントへの再接続を待っていたエクゼキュータは自己終了します。**注:** どのフレームワークでもチェックポイントを有効にしていない場合、エージェントが死んだときに、エージェントで実行されているエクゼキュータとタスクは消滅し、回復しません。

再起動したエージェントは、タイムアウト(デフォルトでは75秒。[設定フラグ](configuration.md)の`--max_agent_ping_timeouts`および`--agent_ping_timeout`を参照)以内にマスターに再登録しなければなりません。エージェントの再登録にこのタイムアウト以上の時間がかかると、マスターはエージェントをシャットダウンし、その結果、実行中のエクゼキュータ/タスクもシャットダウンされます。

したがって、[monit](http://mmonit.com/monit/)や`systemd`などのプロセス・スーパバイザを使用するなどして、エージェントの再起動プロセスを自動化することを強くお勧めします。

## `systemd`とプロセスの寿命に関する既知の問題

`systemd` を使用して `mesos-agent` を起動する際に、既知の問題があります。この問題の説明は [MESOS-3425](https://issues.apache.org/jira/browse/MESOS-3425) にあり、関連するすべての作業は [MESOS-3007](https://issues.apache.org/jira/browse/MESOS-3007) で追跡できます。

この問題は Mesos `0.25.0` の mesos containerizer で cgroups アイソレーションが有効な場合に修正されました。posix アイソレータと docker コ ンテナライザのさらなる修正は、`0.25.1`、`0.26.1`、`0.27.1`、`0.28.0` にあります。

`systemd` プロセスの [KillMode](http://www.freedesktop.org/software/systemd/man/systemd.kill.html) はデフォルトの `control-group` を使用することをお勧めします。これは、エージェントの停止時にすべての子プロセスをkillするものです。これにより、`fetcher` や `perf` などの「サイドカー」プロセスがエージェントと一緒に終了するようになります。Mesosのsystemdパッチでは、エグゼキュータとその子プロセスを別の `systemd` スライスに明示的に移動させ、エージェントからその寿命を切り離しています。これにより、エージェントの再起動後もエクゼキュータが存続するようになります。

次の例は、`systemd`ユニット設定ファイルの抜粋で、フラグを明示的に設定する方法を示しています。:

```
[Service]
ExecStart=/usr/bin/mesos-agent
KillMode=control-cgroup
```
