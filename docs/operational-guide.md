---
title: Apache Mesos - Operational Guide
layout: documentation
---

# 操作ガイド

## プロセススーパーバイザーの活用
Mesosはエラー処理に "[fail-fast](https://en.wikipedia.org/wiki/Fail-fast)"アプローチを採用しています。:重大なエラーが発生した場合、Mesosは通常、エラーが発生する可能性のある状態で実行を続けるのではなく、終了します。たとえば、Mesosが[ハイアベイラビリティ](high-availability.md)に設定されている場合、リーディングマスターは、Zookeeperのクォーラムからパーティショニングされていることを発見すると、自らを終了させます。これは、前のリーダーが安全でない状態で通信を続けないようにするための安全対策です。

このような障害を適切に処理するために、Mesosの本番環境では通常、プロセススーパーバイザ（systemdやsupervisordなど）を使用してMesosプロセスの終了を検出します。スーパバイザは、障害が発生したプロセスを自動的に再起動したり、クラスタオペレータに通知して状況を調査するように設定できます。

## マスタークォーラムの変更
マスターは[Paxosベースのレプリケートログ](replicated-log-internals.md)をストレージバックエンドとして活用します（`--registry=replicated_log`は現在サポートされている唯一のストレージバックエンドです）。各マスターはログのレプリカとしてアンサンブルに参加します。`--quorum` フラグでマスターの過半数を決定します。

次の表は、各クォーラムサイズにおけるマスターの障害に対する耐性を示しています。:

| マスター  | クォーラムサイズ | 失敗の許容範囲 |
| -------: | ----------: | ----------------: |
|        1 |           1 |                 0 |
|        3 |           2 |                 1 |
|        5 |           3 |                 2 |
|      ... |         ... |               ... |
|   2N - 1 |           N |             N - 1 |

高可用性を求める場合には、3つまたは5つのマスターで運用することをお勧めします。

### 注意
クォーラムを設定する際には、上の表で指定された数だけのマスターが稼働していることを確認することが重要です。さらにマスターが動作していると、クォーラムに違反し、ログが破損する可能性があります。そのため、マスターホストの静的なホワイトリストを強制するもので、マスタープロセスの実行をゲートすることをお勧めします。Mesos自体で安全なホワイトリストを追加するには、[MESOS-1546](https://issues.apache.org/jira/browse/MESOS-1546)を参照してください。

ログのオンライン再設定については、以下を参照してください。[MESOS-683](https://issues.apache.org/jira/browse/MESOS-683)を参照してください。

### クォーラムサイズの増やす
クラスタの規模が大きくなると、フォールトトレランスを高めるためにクォーラムサイズを大きくしたいと思うことがあります。

以下の手順は、3→5マスターを例に、クォーラムサイズを増やす方法を示しています。（クォーラムサイズ2→3）:

1. 初期状態では、`--quorum=2`で3つのマスターが動作しています。
2. 元の3台のマスターを `--quorum=3` で再起動します。
3. 2台のマスターを `--quorum=3` で追加起動します。

クォーラムをN倍にするには、このプロセスを繰り返してクォーラムサイズをN倍にします。

注: 現在、シングルマスターの設定を解除するには、複製されたログの状態を消去して新たに始める必要があります。これにより、すべての永続的なデータ（エージェント、メンテナンス情報、クォータ情報など）が消去されます。1マスターから3マスターに移行するには:

1. スタンドアロン・マスターを停止します。
2. 複製されたログデータ（`--work_dir`の下の`replicated_log`）を削除します。
3. 元のマスターと2つの新しいマスターを `--quorum=2` で起動します。

### クォーラムサイズを減らす

以下の手順は、5→3のマスターを例に、クォーラムサイズを減少させる方法を示しています。（クォーラムサイズ3→2）:

1. 初期状態では5台のマスターが`--quorum=3`で動作しています。
2. 2つのマスターをクラスタから削除し、再起動されないようにします(上記のNOTEセクションを参照)。現在、3台のマスターが `--quorum=3` で動作しています。
3. 3台のマスターを`--quorum=2`で再起動します。

クォーラムをN倍にするには、このプロセスを繰り返してクォーラムサイズをN倍にします。

### マスターの交換
上記の注意セクションを参照してください。故障したマスターがアンサンブルに再参加しないことが保証されている限り、ログを空にして新しいマスターを起動し、追いつくのを待つのが安全です。

## Mesosマスターの外部アクセス
デフォルトIP(またはコマンドライン引数`--ip`)が内部IPの場合、フレームワークスケジューラーなどの外部エンティティはマスターにアクセスできません。このシナリオに対処するために、外部からアクセス可能なIP:ポートを`mesos-master`の`--advertise_ip`および`--advertise_port`コマンドライン引数で設定できます。設定されている場合、フレームワークスケジューラーなどの外部エンティティはadvertise_ip:advertise_portと対話し、そこからリクエストをMesosマスターがリッスンしている内部IP:ポートにプロキシする必要があります。

## ノンリーディングマスターへのHTTPリクエスト
いくつかのマスターエンドポイント（例：[/state](endpoints/master/state.md)、[/machine/down](endpoints/master/machine/down.md)）へのHTTPリクエストは、リーディングマスターによってのみ回答されます。リードしていないマスターへのそのようなリクエストは、`307 Temporary Redirect`（リードしているマスターの場所を示す）または`503 Service Unavailable`（マスターが現在のリーダーを知らない場合）のいずれかになります。
