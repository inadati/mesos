---
title: Apache Mesos - Roles
layout: documentation
---

# Roles
最近のホストレベルのオペレーティングシステム（Linux、BSDなど）の多くは、複数のユーザーをサポートしています。同様に、Mesosはマルチユーザーのクラスタ管理システムであり、1つのMesosクラスタが組織のリソースを管理し、組織のユーザーにサービスを提供することを想定しています。

そのため、Mesosはリソース管理に関する多くの要件に対応する必要があります。:


* ユーザー間でのリソースの公平な共有
* ユーザーへのリソース保証の提供（例：クォータ、プライオリティ、アイソレーション）
* 正確なリソースアカウンティングの提供
  * どれだけのリソースが割り当てられているのか、利用されているのか、など。
  * ユーザーごとのアカウンティング

Mesosでは、これらの「ユーザー」をロールと呼びます。より正確には、Mesosにおけるロールとは、クラスタ内のリソース消費者を指します。このリソース消費者は、組織内のユーザーのほか、チーム、グループ、サービス、フレームワークなどを表すこともあります。

スケジューラは、サービスを提供しているリソース消費者に代わってリソースを受け取り、作業をスケジューリングするために、1つまたは複数のロールにサブスクライブします。

Mesosが提供するリソース割り当て保証の例:

* ロールに指定された量のリソースが割り当てられることを保証する（[クォータ](quota.md)経由）。
* 特定のエージェント上のリソースの一部（またはすべて）が特定のロールに割り当てられることを保証する（[reservations](reservation.md)経由）。
* ロール間でリソースが公平に共有されることを保証する（[DRF](https://www.cs.berkeley.edu/~alig/papers/drf.pdf)経由）。
* いくつかのロールがクラスタのより高い相対的なシェアを受け取るべきであることを表現します（[weights](weights.md)経由）。

## ロールとアクセスコントロール
フレームワークがサブスクライブできるロールを制御する方法は2つあります。まず、ACL を使用して、どのフレームワークのプリンシパルがどのロールをサブスクライブできるかを指定できます。詳細については、[authorization](authorization.md)のドキュメントを参照してください。

次に、起動時にMesosマスターに`--roles`フラグを渡すことで、ロールのホワイトリストを設定することができます。このフラグは、コンマで区切られたロール名のリストを指定します。ホワイトリストが指定されると、ホワイトリストに登場するロールのみが使用できます。ホワイトリストを変更するには、Mesosマスターの再起動が必要です。なお、Mesosの高可用性導入では、すべてのMesosマスターに同じホワイトリストが設定されるように注意する必要があります。

これらのバージョンのMesosでは、ホワイトリストに表示されないロールは使用できないため、Mesos 0.26およびそれ以前のバージョンでは、通常、ACLとホワイトリストの両方を構成する必要があります。

Mesos 0.27では、この動作が変更されました。`--roles`が指定されていない場合、ホワイトリストは任意のロール名の使用を許可します。したがって、Mesos 0.27では、使用可能なロールを定義するためにACLのみを使用することが推奨されます。
コマンドラインフラグ `--roles` は非推奨です。

## フレームワークとロールの関連付け

フレームワークは、マスターでサブスクライブする際に、どのロールをサブスクライブしたいかを指定します。これは、`FrameworkInfo`の`roles`フィールドで行います。フレームワークは、更新された`FrameworkInfo`を使って再登録することで、サブスクライブするロールを変更することもできます。

ユーザーとしては、通常、フレームワークの起動時にフレームワークがサブスクライブするロールを指定できます。これを行う方法は、使用しているフレームワークのユーザー・インターフェースに依存します。例えば、シングルユーザースケジューラは`--mesos_role`コマンドラインフラグを取り、マルチユーザースケジューラは`--mesos-roles`コマンドラインフラグを取るか、組織のLDAPシステムと同期して、組織の構造が変わったときにどのロールを購読するかを自動的に調整することができます。

### 複数のロールにサブスクライブする
前述のとおり、フレームワークは複数のロールを同時にサブスクライブできます。これを希望するフレームワークは、`MULTI_ROLE`ケイパビリティにオプトインしなければなりません。

フレームワークがリソースを提供されると、それらのリソースは、フレームワークがサブスクライブしたロールのうちの正確に1つに関連付けられます。フレームワークは、オファーの`allocation_info.role`フィールド、または`Offer`された各Resourceの`allocation_info.role`フィールドを参照することで、オファーがどのロールのためのものであるかを判断することができます（現在の実装では、1つの`Offer`内のすべてのリソースは、同じロールに割り当てられます）。

<a id="roles-multiple-frameworks"></a>

### 同じ役割で複数のフレームワークを使用

複数のフレームワークを同じロールにサブスクライブすることができます。例えば、あるフレームワークがパーシステント・ボリュームを作成し、そこにデータを書き込むことができます。例えば、あるフレームワークがパーシステント・ボリュームを作成し、そこにデータを書き込むことができます。パーシステント・ボリュームにデータを書き込むタスクが終了すると、そのボリュームは同じロールにサブスクライブしている他のフレームワークに提供されます。

ただし、複数のフレームワークが同じ役割を使用するように設定することには注意が必要です。なぜなら、すべてのフレームワークがその役割のために予約されたリソースにアクセスできるからです。例えば、あるフレームワークが機密情報をパーシステント・ボリュームに保存している場合、そのボリュームが同じ役割に加入している別のフレームワークに提供される可能性があります。同様に、あるフレームワークがパーシステント・ボリュームを作成した場合、同じ役割にサブスクライブしている別のフレームワークがそのボリュームを「盗む」ことで、自分のタスクを起動するために使用する可能性があります。一般に、同じ役割を共有する複数のフレームワークは、役割固有のリソースが適切に使用されるように、互いに協力する準備をしておく必要があります。

## リソースとロールの関連付け
リソースは、予約によってロールに割り当てられます。リソースは、静的に（リソースをホストするエージェントの起動時に）予約することも、動的に予約することもできます。フレームワークやオペレータは、特定のロールが使用するために、特定のリソースを後から予約するように指定できます。詳細については、[reservation](reservation.md)のドキュメントを参照してください。

## Default role
`*`という名前の役割は特別なものです。予約されていないリソースは、現在のところ、特別な`*`ロールを持っていると表現されます(`*`はどんなロールにもマッチするという考え方です)。デフォルトでは、エージェント・ノードのすべてのリソースは予約されていません (これは、エージェントの起動時に `--default_role` コマンドライン・フラグで変更できます)。

また、フレームワークが`FrameworkInfo.role`を提供せずに登録した場合、`*`ロールに割り当てられます。Mesos 1.3では、フレームワークは`FrameworkInfo.roles`フィールドを使用する必要があります。このフィールドにはデフォルトの`*`は割り当てられていませんが、フレームワークは必要に応じて`*`を明示的に指定することができます。フレームワークとオペレータは、`*`ロールに予約を入れることはできません。

## 無効なロール名

ロール名は有効なディレクトリ名である必要があるため、以下はできません。:

* 空の文字列であること
* `.`または`..`である。
* `-`で始まる。
* スラッシュ、バックスペース、ホワイトスペースのいずれかを含む。

## ロールとリソース割り当て
デフォルトでは、Mesosマスターは加重ドミナント・リソース・フェアネス（wDRF）を使用してリソースを割り当てます。具体的には、このwDRFの実装では、まず、どのロールがそのロールの支配的なリソースの公正なシェアを最も下回っているかを特定します。そして、その役割に加入しているフレームワークに、順番に追加のリソースを提供します。

デフォルトでは、すべてのロールのウェイトは1です。[ウェイト](weights.md)の設定には、[/weights](endpoints/master/weights.md)オペレータエンドポイントを使用するか、またはMesosマスタの起動時に廃止された`--weights`コマンドラインフラグを使用します。

## ロールとクオータ
あるロールに特定の量のリソースが割り当てられることを保証するために、[/quota](endpoints/master/quota.md)エンドポイントでクォータを指定できます。

リソースアローケータは、残りのリソースを公平に分配する前に、まずクォータの要件を満たすように試みます。詳細については、[quota](quota.md)のドキュメントを参照してください。

## ロールとプリンシパル
プリンシパルは、Mesosと対話するエンティティを識別するもので、ユーザー名に似ています。例えば、フレームワークはMesosマスターに登録する際にプリンシパルを提供し、オペレータはオペレータHTTPエンドポイントを使用する際にプリンシパルを提供します。エンティティは、そのアイデンティティを証明するためにプリンシパルによる[認証](authentication.md)を要求されることがあり、プリンシパルは、[リソースの予約](reservation.md)や[パーシステントボリューム](persistent-volume.md)の作成/破棄など、エンティティが実行するアクションを[認可](authorization.md)するために使用されることがあります。

一方、ロールは、前述のように、リソースの割り当てにのみ使用されます。
